<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="redux-store.html">


<dom-module id="smag-projet">

  <template>

    <iron-ajax
    id="getVocab"
    url="{{url}}"
    handle-as="xml"
    on-error="ajaxError"
    on-response="_computeForm"
    debounce-duration="300"> </iron-ajax>
    <!--  https://jsonplaceholder.typicode.com/users}}-->
    <!--     last-response="{{jsondata}}" -->

 
    <h3>Nous avons [[vocabClasses.length]] classes et [[vocabProperties.length]] propriete(s) </h3>
   
  <!--<paper-dropdown-menu label="Classes"  style="width:20em">
  <paper-listbox class="dropdown-content" id="classesListBox" style="width:20em" on-iron-select="_classeSelected" > 
    <template is="dom-repeat" items="[[vocabClasses]]" as="classe">
      <paper-item >{{label(classe)}}</paper-item>
    </template>
  </paper-listbox>
</paper-dropdown-menu>-->

  <paper-dropdown-menu label="Proprietes"  >
  <paper-listbox class="dropdown-content" id="propertiesListBox"  on-iron-select="_propertieSelected" > <!--selected="1"-->
    <template is="dom-repeat" items="[[vocabProperties]]" as="propriete">
      <paper-item >{{label(propriete)}}</paper-item>
    </template>
  </paper-listbox>
</paper-dropdown-menu>

    <div id="results"></div>
  </template>

  <script>
  Polymer({
    is: 'smag-projet',
    behaviors: [ ReduxBehavior ],
    properties: {
      /*statements: {
      type: Array,
      statePath: 'statements'
    },
    statementCount: {
    type: Number,
    computed: 'computedStatementCount(statements)'
  }*/
  currentVue:{
    type: Object,
    statePath: 'currentVue',
    observer: '_updateVue'
  },
  vocabClasses: {
    type:Array,
    value: []
  } ,
  vocabProperties:{
    type:Array,
    value:[]
  },
  vocabOntologie:{
    type: Object,
    value: {} 
   }
  /*  jsondata:{
  type: Array,
  notify:true,
  observer: '_vocabLoaded'
}*/
},
/*computedStatementCount: function(statements) {
return statements.length;
},*/
label: function(resource){
var result =  "";
var about = resource.attributes['rdf:about'];
var label = resource.attributes['rdfs:label'];
if (label != undefined ){
result = label.nodeValue;
}else{
  result = about.nodeValue.split("#")[1];
}
//resultTemp = result.split("=");

console.log(result);
return result;
},
_computeForm: function(data){
  this.vocabClasses = [];
  this.vocabProperties = [];
  this.vocabOntologie = [];
  //double gestion car les vocabulaires foaf et doap ne sont pas implémentés pareil : foaf -> plusieurs noeuds, doap : un seul noeud racine, ceci à cause des commentaires dans foaf... GRRR !
  console.log("form");
  console.log(data);
  var reponse=data.detail.response;
   console.log(reponse);
 // console.log(reponse.length);
  var noeuds = reponse.childNodes;
 // console.log(noeuds.length);
  var racine =[];
  if(noeuds.length==1){
    racine=noeuds[0].childNodes;
  }else{
    for(var n=0;n<noeuds.length;n++){
      var noeud = noeuds[n];
      console.log(noeud.nodeName);
      if (noeud.nodeName == "rdf:RDF"){
        racine = noeud.childNodes;
      }
    }
  }

 // console.log(racine);


  for (var i=0;i< racine.length;i++){
    var node = racine[i];
    var nodeType = node.nodeType;
    var nodeValeur = node.nodeValue;
    var nodeName = node.nodeName;
    if (nodeValeur != null){
      nodeValeur=nodeValeur.trim();
      //  console.log(noeudValeur.length);
    }

   
      switch(nodeType) {
        case 3:
      //  console.log(nodeType);
      //  console.log(node);
        break;
        case 1:
      //  console.log(nodeType);
        console.log(node);
        console.log(nodeName);
        switch(nodeName) {
          case "owl:Ontology":
         // console.log("la gestion de "+nodeName+" n'est pas encore implémentée")
         this.vocabOntologie = node;
          break;
          case "rdfs:Class":
          case "owl:Class" : //et rdfs:Class
          this.push('vocabClasses', node);
          break;
          case "owl:AnnotationProperty" :
          console.log("la gestion de "+nodeName+" n'est pas encore implémentée")

          break;
          case "rdf:Property" : 
            this.push('vocabProperties', node);
          break;
          default:
          console.log("la gestion de "+nodeName+" n'est pas encore implémentée")
        }
        break;
        case 8:
        // noeud de type commentaire pas utile pour l'instant
      //  console.log(nodeType);
      //  console.log(node);
        break;
        default:
        console.log(nodeType+ " Non traité encore");
        console.log(node);
      }
  
  }
  //var classes = noeuds.getElementsByTagName("rdfs:Class");
  //console.log(classes.length);

  //  var properties = noeuds.getElementsByTagName("rdf:Property");
  //  console.log(properties.length);
  //  console.log(first);
  //  var x = xmlDoc.getElementsByTagName("title")[0];
  //  var y = racine.childNodes[0];
  //document.getElementById("demo").innerHTML =
  //console.log(y);
  //console.log(y.nodeValue);
  //  console.log();
  //  console.log(data[0].song);
  //  console.log(this.jsondata);
  //  console.log(data.detail.error);
  //  console.log(data.detail.error.message);

  //    alert(this.ajaxR);
  //    alert(this.ajaxR[0].song);
  //  const resp = data.detail.response;
  //  console.log(resp.results)
  //  this.$.results.innerHTML = `<pre>${JSON.stringify(resp, null, ' ')}</pre>`;
 console.log(this.vocabClasses);
 console.log(this.vocabProperties);
},
/**
* en cas d'erreur de la requete
*/
ajaxError : function(data){
  console.log(data);
  console.log(data.detail.response);
  console.log(data.detail.error);
  console.log(data.detail.error.message);
},
_updateVue: function(e){
  console.log(this.currentVue);
  console.log(e);

  if (Object.keys(this.currentVue).length === 0){
    console.log("vue vide");
  }else{
    // RECHERCHE DES VOCABULAIRES SUR LOV.OKFN.ORG this.url='http://lov.okfn.org/dataset/lov/api/v2/vocabulary/search?q='+this.currentVue; //+'&lang=French'
    if( this.currentVue == "doap"){
      //  this.url='http://usefulinc.com/ns/doap#';
      this.url = 'doap.rdf'
    }else if( this.currentVue == "foaf"){
      this.url = 'foaf.rdf'
      //  this.url='http://xmlns.com/foaf/spec/index.rdf';
    }
    this.$.getVocab.generateRequest();
  }
},
/*_vocabLoaded: function(data){
console.log("vocabchanged");
console.log(data);
}*/
});

</script>

</dom-module>
